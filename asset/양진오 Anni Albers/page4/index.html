<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Page N</title>
    <style>
      body {
        padding: 0;
        margin: 0;
        background-color: #1b1b1b;
        touch-action: none;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <div id="ui-root">
      <div id="tabs"></div>
      <div id="controls"></div>
      <div id="panel"></div>
    </div>

    <script defer src="../lib/p5.min.js"></script>
    <script defer src="../lib/p5.sound.js"></script>
    <script defer src="../lib/matter.min.js"></script>

    <script defer src="./section3_shuttle.js"></script>

    <script defer>
      window.createTabs =
        window.createTabs ||
        function (labels = [], onSelect) {
          const root = document.getElementById("tabs") || document.body; // 컨테이너 없으면 body 사용
          root && (root.innerHTML = "");
          const api = { setActive() {}, destroy() {} };

          // 탭들 생성(컨테이너가 있을 때만)
          if (root && root !== document.body) {
            labels.forEach((label, i) => {
              const b = document.createElement("button");
              b.className = "tab";
              b.textContent = String(label ?? `Tab ${i + 1}`);
              b.addEventListener("click", () => onSelect && onSelect(i));
              root.appendChild(b);
            });
            api.setActive = (i) => {
              [...root.querySelectorAll(".tab")].forEach((el, idx) => {
                el.classList.toggle("active", idx === i);
              });
            };
            api.destroy = () => {
              root.innerHTML = "";
            };
          }
          return api;
        };
    </script>

    <!-- 3) 전역 매핑 + 어댑터 -->
    <script defer>
      (function forceFirstTo(targetName, realName) {
        // 호출 순간에 실제 구현을 해석
        function resolve() {
          return window[realName] || window[targetName];
        }

        function asCallable() {
          return function (...args) {
            const Impl = resolve();
            if (!Impl) {
              console.error(
                "Section impl not loaded yet:",
                targetName,
                realName
              );
              return {};
            }
            try {
              return Impl(...args);
            } catch {
              // 함수 팩토리인 경우 (예: Section4_PatternTiles) :contentReference[oaicite:2]{index=2}
              return new Impl(...args);
            } // 클래스인 경우도 대비
          };
        }

        // core는 0번부터 시작 → 0번 이름을 타깃 섹션으로 위장
        window.Section0_QuarterWeave = asCallable();

        // 혹시 core가 배열에서 타깃 이름도 직접 호출할 수 있으니 동일 이름도 보강
        window[targetName] = asCallable();

        // 나머지 이름은 비어 있으면 더미로 채워 에러 방지 (옵션)
        [
          "Section1_LoomGrid",
          "Section2_WeftRipple",
          "Section3_ShuttleChannels",
          "Section4_PatternTiles",
          "Section5_Something",
        ].forEach((n) => {
          if (!window[n])
            window[n] = function () {
              return {};
            };
        });
      })(
        "Section3_ShuttleChannels", // ← core가 기대하는 전역 섹션 이름 (예: 'Section3_ShuttleChannels')
        "Section3_ShuttleChannels" // ← 실제 섹션 파일이 만드는 전역 이름(같으면 동일 문자열)
      );
    </script>

    <!-- 4) core (+ ui) -->
    <script defer src="../app/core.js"></script>

    <!-- TODO: ui.js를 실제로 쓸 거면 아래 주석 해제 (컨테이너 유지 필수) -->
    <!-- <script defer src="../app/ui.js"></script> -->
  </body>
</html>
